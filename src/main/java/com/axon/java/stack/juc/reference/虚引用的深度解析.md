# ğŸ”® **è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰æ·±åº¦è§£æ**

## ğŸ¯ **è™šå¼•ç”¨çš„æœ¬è´¨ç†è§£**

### **ğŸ“‹ è™šå¼•ç”¨çš„æ ¸å¿ƒç‰¹æ€§**

```java
public class PhantomReferenceNature {
    
    public void explainPhantomReferenceCharacteristics() {
        System.out.println("ğŸ”® è™šå¼•ç”¨æ ¸å¿ƒç‰¹æ€§ï¼š");
        System.out.println("1ï¸âƒ£ get()æ–¹æ³•æ°¸è¿œè¿”å›null");
        System.out.println("2ï¸âƒ£ ä¸å½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ");
        System.out.println("3ï¸âƒ£ å¿…é¡»ä¸ReferenceQueueé…åˆä½¿ç”¨");
        System.out.println("4ï¸âƒ£ ç”¨äºç›‘æ§å¯¹è±¡çš„å›æ”¶çŠ¶æ€");
        System.out.println("5ï¸âƒ£ åœ¨å¯¹è±¡finalizeåæ‰ä¼šè¢«åŠ å…¥é˜Ÿåˆ—");
    }
}
```

---

## ğŸ” **è™šå¼•ç”¨ vs å…¶ä»–å¼•ç”¨ç±»å‹å¯¹æ¯”**

```java
import java.lang.ref.*;

public class ReferenceTypesComparison {
    
    private static class TestObject {
        private String name;
        
        public TestObject(String name) {
            this.name = name;
        }
        
        @Override
        protected void finalize() throws Throwable {
            System.out.println("ğŸ—‘ï¸ " + name + " å¯¹è±¡è¢«finalize");
            super.finalize();
        }
        
        @Override
        public String toString() {
            return "TestObject{name='" + name + "'}";
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        demonstrateAllReferenceTypes();
    }
    
    public static void demonstrateAllReferenceTypes() throws InterruptedException {
        ReferenceQueue<TestObject> queue = new ReferenceQueue<>();
        
        // åˆ›å»ºæµ‹è¯•å¯¹è±¡
        TestObject obj1 = new TestObject("StrongRef");
        TestObject obj2 = new TestObject("WeakRef");
        TestObject obj3 = new TestObject("SoftRef");
        TestObject obj4 = new TestObject("PhantomRef");
        
        // 1ï¸âƒ£ å¼ºå¼•ç”¨ - æ°¸ä¸å›æ”¶
        // TestObject strongRef = obj1; // å¼ºå¼•ç”¨
        
        // 2ï¸âƒ£ å¼±å¼•ç”¨ - GCæ—¶ç«‹å³å›æ”¶
        WeakReference<TestObject> weakRef = new WeakReference<>(obj2, queue);
        
        // 3ï¸âƒ£ è½¯å¼•ç”¨ - å†…å­˜ä¸è¶³æ—¶å›æ”¶
        SoftReference<TestObject> softRef = new SoftReference<>(obj3, queue);
        
        // 4ï¸âƒ£ è™šå¼•ç”¨ - ä¸å½±å“å›æ”¶ï¼Œç›‘æ§å›æ”¶çŠ¶æ€
        PhantomReference<TestObject> phantomRef = new PhantomReference<>(obj4, queue);
        
        System.out.println("ğŸš€ åˆ›å»ºå®Œæ¯•ï¼Œå¼€å§‹æµ‹è¯•å¼•ç”¨è¡Œä¸º");
        
        // ç§»é™¤å¼ºå¼•ç”¨
        obj2 = null; // ç§»é™¤å¼±å¼•ç”¨çš„å¼ºå¼•ç”¨
        obj3 = null; // ç§»é™¤è½¯å¼•ç”¨çš„å¼ºå¼•ç”¨  
        obj4 = null; // ç§»é™¤è™šå¼•ç”¨çš„å¼ºå¼•ç”¨
        
        System.out.println("\nğŸ“Š GCå‰çš„å¼•ç”¨çŠ¶æ€ï¼š");
        System.out.println("WeakRef.get(): " + weakRef.get());
        System.out.println("SoftRef.get(): " + softRef.get());
        System.out.println("PhantomRef.get(): " + phantomRef.get()); // æ°¸è¿œä¸ºnull
        
        // å¼ºåˆ¶GC
        System.out.println("\nğŸ—‘ï¸ æ‰§è¡ŒGC...");
        System.gc();
        System.runFinalization(); // ç¡®ä¿finalizeæ‰§è¡Œ
        Thread.sleep(1000); // ç­‰å¾…GCå®Œæˆ
        
        System.out.println("\nğŸ“Š GCåçš„å¼•ç”¨çŠ¶æ€ï¼š");
        System.out.println("WeakRef.get(): " + weakRef.get());
        System.out.println("SoftRef.get(): " + softRef.get());
        System.out.println("PhantomRef.get(): " + phantomRef.get()); // ä»ç„¶ä¸ºnull
        
        // æ£€æŸ¥å¼•ç”¨é˜Ÿåˆ—
        checkReferenceQueue(queue);
    }
    
    private static void checkReferenceQueue(ReferenceQueue<TestObject> queue) {
        System.out.println("\nğŸ” æ£€æŸ¥å¼•ç”¨é˜Ÿåˆ—ï¼š");
        Reference<? extends TestObject> ref;
        while ((ref = queue.poll()) != null) {
            if (ref instanceof WeakReference) {
                System.out.println("ğŸ“¤ WeakReference è¿›å…¥é˜Ÿåˆ—");
            } else if (ref instanceof SoftReference) {
                System.out.println("ğŸ“¤ SoftReference è¿›å…¥é˜Ÿåˆ—");
            } else if (ref instanceof PhantomReference) {
                System.out.println("ğŸ“¤ PhantomReference è¿›å…¥é˜Ÿåˆ— - å¯¹è±¡å·²è¢«å›æ”¶ï¼");
            }
        }
    }
}
```

---

## âš¡ **è™šå¼•ç”¨çš„å·¥ä½œæœºåˆ¶æ·±åº¦è§£æ**

### **ğŸ”„ è™šå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸ**

```java
public class PhantomReferenceLifecycle {
    
    private static class MonitoredObject {
        private final String id;
        private final byte[] data; // æ¨¡æ‹Ÿå ç”¨å†…å­˜
        
        public MonitoredObject(String id) {
            this.id = id;
            this.data = new byte[1024 * 1024]; // 1MBæ•°æ®
            System.out.println("ğŸ†• åˆ›å»ºå¯¹è±¡: " + id);
        }
        
        @Override
        protected void finalize() throws Throwable {
            System.out.println("ğŸ finalize(): " + id);
            super.finalize();
        }
    }
    
    // ğŸ¯ è‡ªå®šä¹‰è™šå¼•ç”¨ï¼Œæºå¸¦æ¸…ç†ä¿¡æ¯
    private static class CleanupPhantomReference extends PhantomReference<MonitoredObject> {
        private final String objectId;
        private final Runnable cleanupAction;
        
        public CleanupPhantomReference(MonitoredObject referent, 
                                     ReferenceQueue<? super MonitoredObject> q,
                                     String objectId,
                                     Runnable cleanupAction) {
            super(referent, q);
            this.objectId = objectId;
            this.cleanupAction = cleanupAction;
        }
        
        public void cleanup() {
            System.out.println("ğŸ§¹ æ‰§è¡Œæ¸…ç†æ“ä½œ: " + objectId);
            if (cleanupAction != null) {
                cleanupAction.run();
            }
        }
        
        public String getObjectId() {
            return objectId;
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        demonstratePhantomReferenceLifecycle();
    }
    
    public static void demonstratePhantomReferenceLifecycle() throws InterruptedException {
        ReferenceQueue<MonitoredObject> queue = new ReferenceQueue<>();
        
        // åˆ›å»ºå¤šä¸ªè¢«ç›‘æ§çš„å¯¹è±¡
        CleanupPhantomReference[] phantomRefs = new CleanupPhantomReference[3];
        
        for (int i = 0; i < 3; i++) {
            final int index = i;
            MonitoredObject obj = new MonitoredObject("Object-" + i);
            
            // åˆ›å»ºè™šå¼•ç”¨ï¼Œé™„å¸¦æ¸…ç†é€»è¾‘
            phantomRefs[i] = new CleanupPhantomReference(
                obj, 
                queue,
                "Object-" + i,
                () -> {
                    System.out.println("ğŸ’¾ é‡Šæ”¾èµ„æº: Object-" + index);
                    // è¿™é‡Œå¯ä»¥æ‰§è¡Œå®é™…çš„æ¸…ç†æ“ä½œ
                    // æ¯”å¦‚å…³é—­æ–‡ä»¶å¥æŸ„ã€é‡Šæ”¾nativeå†…å­˜ç­‰
                }
            );
            
            obj = null; // ç§»é™¤å¼ºå¼•ç”¨
        }
        
        System.out.println("\nğŸ—‘ï¸ å¼ºåˆ¶è§¦å‘GC...");
        
        // å¯åŠ¨ç›‘æ§çº¿ç¨‹
        Thread monitorThread = startReferenceQueueMonitor(queue);
        
        // å¤šæ¬¡GCç¡®ä¿å¯¹è±¡è¢«å›æ”¶
        for (int i = 0; i < 3; i++) {
            System.gc();
            System.runFinalization();
            Thread.sleep(500);
        }
        
        Thread.sleep(2000); // ç­‰å¾…ç›‘æ§çº¿ç¨‹å¤„ç†
        monitorThread.interrupt();
    }
    
    private static Thread startReferenceQueueMonitor(ReferenceQueue<MonitoredObject> queue) {
        Thread monitorThread = new Thread(() -> {
            System.out.println("ğŸ‘€ å¯åŠ¨å¼•ç”¨é˜Ÿåˆ—ç›‘æ§çº¿ç¨‹");
            
            try {
                while (!Thread.currentThread().isInterrupted()) {
                    Reference<? extends MonitoredObject> ref = queue.remove(100);
                    
                    if (ref instanceof CleanupPhantomReference) {
                        CleanupPhantomReference phantomRef = (CleanupPhantomReference) ref;
                        System.out.println("ğŸš¨ æ£€æµ‹åˆ°å¯¹è±¡å›æ”¶: " + phantomRef.getObjectId());
                        
                        // æ‰§è¡Œæ¸…ç†æ“ä½œ
                        phantomRef.cleanup();
                        
                        // æ¸…ç†è™šå¼•ç”¨æœ¬èº«
                        phantomRef.clear();
                    }
                }
            } catch (InterruptedException e) {
                System.out.println("ğŸ›‘ ç›‘æ§çº¿ç¨‹ç»“æŸ");
            }
        }, "PhantomRef-Monitor");
        
        monitorThread.setDaemon(true);
        monitorThread.start();
        return monitorThread;
    }
}
```

---

## ğŸ› ï¸ **è™šå¼•ç”¨çš„å®é™…åº”ç”¨åœºæ™¯**

### **1ï¸âƒ£ DirectByteBufferå†…å­˜ç®¡ç†**

```java
import java.lang.ref.PhantomReference;
import java.lang.ref.ReferenceQueue;
import java.nio.ByteBuffer;
import java.util.concurrent.ConcurrentHashMap;

// ğŸ¯ æ¨¡æ‹ŸDirectByteBufferçš„è™šå¼•ç”¨æ¸…ç†æœºåˆ¶
public class DirectMemoryManager {
    
    // æ¨¡æ‹Ÿnativeå†…å­˜è·Ÿè¸ª
    private static final ConcurrentHashMap<PhantomReference<ByteBuffer>, Long> 
        nativeMemoryTracker = new ConcurrentHashMap<>();
    
    private static final ReferenceQueue<ByteBuffer> referenceQueue = new ReferenceQueue<>();
    private static long totalAllocatedMemory = 0L;
    
    // ğŸ”§ è‡ªå®šä¹‰è™šå¼•ç”¨ç”¨äºè·Ÿè¸ªDirectByteBuffer
    private static class DirectBufferPhantomReference extends PhantomReference<ByteBuffer> {
        private final long size;
        private final long address; // æ¨¡æ‹Ÿnativeå†…å­˜åœ°å€
        
        public DirectBufferPhantomReference(ByteBuffer referent, long size) {
            super(referent, referenceQueue);
            this.size = size;
            this.address = System.identityHashCode(referent); // æ¨¡æ‹Ÿåœ°å€
        }
        
        public void deallocate() {
            System.out.println("ğŸ—‘ï¸ é‡Šæ”¾Nativeå†…å­˜: " + size + " bytes, åœ°å€: 0x" + 
                             Long.toHexString(address));
            
            synchronized (DirectMemoryManager.class) {
                totalAllocatedMemory -= size;
            }
        }
        
        public long getSize() {
            return size;
        }
    }
    
    static {
        // å¯åŠ¨æ¸…ç†çº¿ç¨‹
        startCleanupThread();
    }
    
    // ğŸš€ åˆ†é…DirectByteBufferå¹¶æ³¨å†Œè™šå¼•ç”¨
    public static ByteBuffer allocateDirectBuffer(int size) {
        ByteBuffer buffer = ByteBuffer.allocateDirect(size);
        
        synchronized (DirectMemoryManager.class) {
            totalAllocatedMemory += size;
        }
        
        // åˆ›å»ºè™šå¼•ç”¨è¿›è¡Œè·Ÿè¸ª
        DirectBufferPhantomReference phantomRef = 
            new DirectBufferPhantomReference(buffer, size);
        nativeMemoryTracker.put(phantomRef, (long) size);
        
        System.out.println("ğŸ“¦ åˆ†é…DirectBuffer: " + size + " bytes, " +
                          "æ€»åˆ†é…: " + totalAllocatedMemory + " bytes");
        
        return buffer;
    }
    
    // ğŸ§¹ å¯åŠ¨æ¸…ç†çº¿ç¨‹
    private static void startCleanupThread() {
        Thread cleanupThread = new Thread(() -> {
            System.out.println("ğŸ§¹ DirectBufferæ¸…ç†çº¿ç¨‹å¯åŠ¨");
            
            while (true) {
                try {
                    DirectBufferPhantomReference ref = 
                        (DirectBufferPhantomReference) referenceQueue.remove();
                    
                    System.out.println("ğŸš¨ æ£€æµ‹åˆ°DirectBufferè¢«GCå›æ”¶");
                    
                    // æ‰§è¡Œnativeå†…å­˜æ¸…ç†
                    ref.deallocate();
                    
                    // ä»è·Ÿè¸ªMapä¸­ç§»é™¤
                    nativeMemoryTracker.remove(ref);
                    
                    System.out.println("âœ… æ¸…ç†å®Œæˆï¼Œå‰©ä½™åˆ†é…: " + totalAllocatedMemory + " bytes");
                    
                } catch (InterruptedException e) {
                    System.out.println("ğŸ›‘ æ¸…ç†çº¿ç¨‹è¢«ä¸­æ–­");
                    break;
                }
            }
        }, "DirectBuffer-Cleaner");
        
        cleanupThread.setDaemon(true);
        cleanupThread.start();
    }
    
    // ğŸ“Š è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
    public static void printMemoryStatus() {
        System.out.println("\nğŸ“Š å†…å­˜çŠ¶æ€:");
        System.out.println("è·Ÿè¸ªçš„å¼•ç”¨æ•°é‡: " + nativeMemoryTracker.size());
        System.out.println("æ€»åˆ†é…å†…å­˜: " + totalAllocatedMemory + " bytes");
        System.out.println("JVMå †å†…å­˜: " + 
                          (Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory()) 
                          + " bytes");
    }
    
    // ğŸ§ª æµ‹è¯•æ–¹æ³•
    public static void main(String[] args) throws InterruptedException {
        System.out.println("ğŸ§ª DirectMemoryManager æµ‹è¯•");
        
        // åˆ†é…å¤šä¸ªDirectBuffer
        for (int i = 0; i < 5; i++) {
            ByteBuffer buffer = allocateDirectBuffer(1024 * 1024); // 1MB
            // buffer åœ¨å¾ªç¯ç»“æŸåå¤±å»å¼ºå¼•ç”¨
        }
        
        printMemoryStatus();
        
        System.out.println("\nğŸ—‘ï¸ è§¦å‘GC...");
        
        // å¤šæ¬¡GCç¡®ä¿DirectBufferè¢«å›æ”¶
        for (int i = 0; i < 3; i++) {
            System.gc();
            System.runFinalization();
            Thread.sleep(1000);
            printMemoryStatus();
        }
        
        Thread.sleep(2000); // ç­‰å¾…æ¸…ç†çº¿ç¨‹å®Œæˆå·¥ä½œ
        System.out.println("ğŸ æµ‹è¯•å®Œæˆ");
    }
}
```

### **2ï¸âƒ£ èµ„æºæ¸…ç†æ¡†æ¶**

```java
// ğŸ—ï¸ é€šç”¨èµ„æºæ¸…ç†æ¡†æ¶
public class ResourceCleanupFramework {
    
    private static final ReferenceQueue<Object> cleanupQueue = new ReferenceQueue<>();
    private static final ConcurrentHashMap<PhantomReference<Object>, Runnable> 
        cleanupActions = new ConcurrentHashMap<>();
    
    static {
        startGlobalCleanupThread();
    }
    
    // ğŸ“ æ³¨å†Œéœ€è¦æ¸…ç†çš„èµ„æº
    public static <T> T registerForCleanup(T resource, Runnable cleanupAction) {
        PhantomReference<Object> phantomRef = new PhantomReference<>(resource, cleanupQueue);
        cleanupActions.put(phantomRef, cleanupAction);
        
        System.out.println("ğŸ“‹ æ³¨å†Œèµ„æºæ¸…ç†: " + resource.getClass().getSimpleName());
        return resource;
    }
    
    // ğŸ§¹ å…¨å±€æ¸…ç†çº¿ç¨‹
    private static void startGlobalCleanupThread() {
        Thread cleanupThread = new Thread(() -> {
            while (true) {
                try {
                    PhantomReference<Object> ref = 
                        (PhantomReference<Object>) cleanupQueue.remove();
                    
                    Runnable cleanup = cleanupActions.remove(ref);
                    if (cleanup != null) {
                        System.out.println("ğŸ§¹ æ‰§è¡Œèµ„æºæ¸…ç†");
                        cleanup.run();
                    }
                    
                } catch (InterruptedException e) {
                    break;
                }
            }
        }, "Global-Resource-Cleaner");
        
        cleanupThread.setDaemon(true);
        cleanupThread.start();
    }
}
```

---

## ğŸ“Š **æ€»ç»“ä¸æœ€ä½³å®è·µ**

### **ğŸ¯ è™šå¼•ç”¨çš„å…³é”®ç‰¹ç‚¹**

| ç‰¹æ€§ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| **get()æ°¸è¿œè¿”å›null** | æ— æ³•é€šè¿‡è™šå¼•ç”¨è®¿é—®å¯¹è±¡ | çº¯ç²¹çš„å›æ”¶ç›‘æ§ |
| **ä¸å½±å“GC** | å¯¹è±¡è¯¥å›æ”¶æ—¶å°±å›æ”¶ | ä¸å¹²æ‰°æ­£å¸¸å†…å­˜ç®¡ç† |
| **å¿…é¡»é…åˆReferenceQueue** | å›æ”¶é€šçŸ¥æœºåˆ¶ | å®ç°æ¸…ç†å›è°ƒ |
| **åœ¨finalizeåå…¥é˜Ÿ** | ç¡®ä¿å¯¹è±¡å®Œå…¨é”€æ¯ | å®‰å…¨çš„æ¸…ç†æ—¶æœº |

### **âœ… æœ€ä½³å®è·µ**

```java
// ğŸ¯ è™šå¼•ç”¨ä½¿ç”¨åŸåˆ™
public class PhantomReferenceBestPractices {
    
    public void bestPractices() {
        System.out.println("âœ… è™šå¼•ç”¨æœ€ä½³å®è·µï¼š");
        System.out.println("1ï¸âƒ£ åªç”¨äºç›‘æ§å¯¹è±¡å›æ”¶ï¼Œä¸ç”¨äºå¯¹è±¡è®¿é—®");
        System.out.println("2ï¸âƒ£ å¿…é¡»é…åˆReferenceQueueä½¿ç”¨");
        System.out.println("3ï¸âƒ£ é€‚åˆnativeèµ„æºç®¡ç†å’Œæ¸…ç†å·¥ä½œ");
        System.out.println("4ï¸âƒ£ æ¸…ç†çº¿ç¨‹åº”è®¾ä¸ºå®ˆæŠ¤çº¿ç¨‹");
        System.out.println("5ï¸âƒ£ åŠæ—¶æ¸…ç†è™šå¼•ç”¨æœ¬èº«é¿å…å†…å­˜æ³„æ¼");
    }
}
```

**ğŸ”‘ æ ¸å¿ƒç†è§£ï¼šè™šå¼•ç”¨æ˜¯JVMæä¾›çš„"å¯¹è±¡æ­»äº¡é€šçŸ¥"æœºåˆ¶ï¼Œè®©æˆ‘ä»¬èƒ½åœ¨å¯¹è±¡è¢«å®Œå…¨å›æ”¶åæ‰§è¡Œæ¸…ç†å·¥ä½œï¼Œæ˜¯å®ç°èµ„æºå®‰å…¨é‡Šæ”¾çš„é‡è¦å·¥å…·ã€‚**

**å»ºè®®ç»§ç»­å­¦ä¹ **ï¼šJavaå†…å­˜æ¨¡å‹ã€GCè°ƒä¼˜ã€NIO DirectByteBufferæºç 