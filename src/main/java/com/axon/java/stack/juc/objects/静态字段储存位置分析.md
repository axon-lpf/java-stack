# ğŸ§  **JVMå†…å­˜åˆ†æï¼šé™æ€å­—æ®µå­˜å‚¨ä½ç½®**

## ğŸ“ **ç­”æ¡ˆï¼šå–å†³äºJVMç‰ˆæœ¬**

### **JDK 8+ (å½“å‰ä¸»æµ)**
```java
private static TestB testB; // å¼•ç”¨å­˜å‚¨åœ¨ï¼šå †ä¸­çš„Classå¯¹è±¡
TestBå®ä¾‹å¯¹è±¡               // å¯¹è±¡å­˜å‚¨åœ¨ï¼šå †ä¸­
```

### **JDK 7åŠä»¥å‰**
```java
private static TestB testB; // å¼•ç”¨å­˜å‚¨åœ¨ï¼šæ–¹æ³•åŒº(æ°¸ä¹…ä»£)
TestBå®ä¾‹å¯¹è±¡               // å¯¹è±¡å­˜å‚¨åœ¨ï¼šå †ä¸­
```

## ğŸ” **è¯¦ç»†åˆ†æ**

### **1ï¸âƒ£ JDK 8+ çš„å†…å­˜å¸ƒå±€**

```java
// JVMå†…å­˜åˆ†å¸ƒç¤ºæ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å †å†…å­˜ (Heap)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚      Classå¯¹è±¡åŒºåŸŸ               â”‚ â”‚
â”‚ â”‚ ObjectTest.class {              â”‚ â”‚
â”‚ â”‚   static TestB testB = 0x1234   â”‚ â”‚ â† é™æ€å­—æ®µå¼•ç”¨
â”‚ â”‚ }                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚      æ™®é€šå¯¹è±¡åŒºåŸŸ               â”‚ â”‚
â”‚ â”‚ TestB@0x1234 {                  â”‚ â”‚ â† å®é™…å¯¹è±¡
â”‚ â”‚   bookName: "java"              â”‚ â”‚
â”‚ â”‚   bookPrice: 100                â”‚ â”‚
â”‚ â”‚ }                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å…ƒç©ºé—´ (Metaspace)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç±»çš„å…ƒæ•°æ®ä¿¡æ¯                     â”‚
â”‚ â€¢ æ–¹æ³•å­—èŠ‚ç                         â”‚
â”‚ â€¢ å¸¸é‡æ±                            â”‚
â”‚ âŒ ä¸åŒ…å«é™æ€å˜é‡                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª **éªŒè¯ä»£ç **

```java
import java.lang.reflect.Field;
import sun.misc.Unsafe;

public class StaticFieldLocationTest {
    
    private static TestB testB = new TestB();
    
    public static void main(String[] args) throws Exception {
        // 1. è·å–Classå¯¹è±¡åœ¨å †ä¸­çš„åœ°å€
        Class<?> clazz = StaticFieldLocationTest.class;
        System.out.println("Classå¯¹è±¡: " + clazz);
        
        // 2. è·å–é™æ€å­—æ®µ
        Field field = clazz.getDeclaredField("testB");
        field.setAccessible(true);
        
        // 3. éªŒè¯é™æ€å­—æ®µçš„å­˜å‚¨ä½ç½®
        Object staticValue = field.get(null);
        System.out.println("é™æ€å­—æ®µå€¼: " + staticValue);
        System.out.println("å¯¹è±¡åœ¨å †ä¸­: " + (staticValue != null));
        
        // 4. å†…å­˜åœ°å€åˆ†æï¼ˆéœ€è¦--add-opens java.base/java.lang=ALL-UNNAMEDï¼‰
        printMemoryInfo();
    }
    
    public static void printMemoryInfo() {
        Runtime runtime = Runtime.getRuntime();
        System.out.println("\n=== å†…å­˜åˆ†æ ===");
        System.out.println("å †å†…å­˜æ€»é‡: " + runtime.totalMemory() / 1024 / 1024 + "MB");
        System.out.println("å †å†…å­˜ä½¿ç”¨: " + (runtime.totalMemory() - runtime.freeMemory()) / 1024 / 1024 + "MB");
        System.out.println("æœ€å¤§å †å†…å­˜: " + runtime.maxMemory() / 1024 / 1024 + "MB");
        
        // å…ƒç©ºé—´ä¿¡æ¯ï¼ˆJDK 8+ï¼‰
        System.out.println("\n=== JVMç‰ˆæœ¬ ===");
        System.out.println("Javaç‰ˆæœ¬: " + System.getProperty("java.version"));
        System.out.println("JVM: " + System.getProperty("java.vm.name"));
    }
    
    static class TestB {
        private String name = "test";
    }
}
```

## ğŸ“Š **ä¸åŒJVMç‰ˆæœ¬å¯¹æ¯”**

| JVMç‰ˆæœ¬ | é™æ€å­—æ®µå¼•ç”¨ä½ç½® | å¯¹è±¡å®ä¾‹ä½ç½® | å¤‡æ³¨ |
|---------|----------------|-------------|------|
| **JDK 6-7** | æ–¹æ³•åŒº(æ°¸ä¹…ä»£) | å † | PermGenå­˜å‚¨é™æ€å˜é‡ |
| **JDK 8+** | å †(Classå¯¹è±¡) | å † | å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£ |

## ğŸ”§ **JDK 8 å†…å­˜å˜åŒ–çš„åŸå› **

### **åŸå› åˆ†æï¼š**
```java
// JDK 7åŠä¹‹å‰çš„é—®é¢˜
PermGenæ°¸ä¹…ä»£ {
    - å¤§å°å›ºå®šï¼Œå®¹æ˜“OutOfMemoryError
    - é™æ€å˜é‡å­˜å‚¨åœ¨è¿™é‡Œ
    - GCæ•ˆç‡ä½
}

// JDK 8çš„æ”¹è¿›
Metaspaceå…ƒç©ºé—´ {
    - ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œè‡ªåŠ¨æ‰©å±•
    - åªå­˜å‚¨ç±»å…ƒæ•°æ®
    - GCæ•ˆç‡æå‡
}

å †å†…å­˜ {
    + Classå¯¹è±¡ç§»å…¥å †ä¸­
    + é™æ€å˜é‡ä½œä¸ºClasså¯¹è±¡çš„ä¸€éƒ¨åˆ†
    + æ›´å¥½çš„GCç®¡ç†
}
```

## ğŸ’¡ **å®é™…å½±å“**

### **1ï¸âƒ£ å†…å­˜æ³„æ¼é£é™©**
```java
// JDK 8+ä¸­ï¼Œé™æ€å­—æ®µåœ¨å †ä¸­
private static TestB testB; // å¼•ç”¨åœ¨å †çš„Classå¯¹è±¡ä¸­
// å¦‚æœtestBæŒ‡å‘å¤§å¯¹è±¡ï¼Œä¼šå ç”¨å †å†…å­˜ç›´åˆ°ç±»å¸è½½
```

### **2ï¸âƒ£ GCè¡Œä¸º**
```java
// JDK 8+çš„ä¼˜åŠ¿
- é™æ€å˜é‡å¯ä»¥è¢«å †GCæ›´å¥½åœ°ç®¡ç†
- å‡å°‘PermGen OOMçš„é£é™©
- Classå¯¹è±¡å’Œé™æ€å˜é‡ä¸€èµ·å›æ”¶
```

## âš¡ **æ€§èƒ½ç›‘æ§å‘½ä»¤**

```bash
# æŸ¥çœ‹å…ƒç©ºé—´ä½¿ç”¨æƒ…å†µï¼ˆJDK 8+ï¼‰
jstat -gc [pid]

# æŸ¥çœ‹ç±»åŠ è½½æƒ…å†µ
jstat -class [pid]

# å †å†…å­˜è¯¦æƒ…
jmap -heap [pid]
```

## ğŸ¯ **ç»“è®º**

- **JDK 8+**: é™æ€å­—æ®µå¼•ç”¨å­˜å‚¨åœ¨**å †ä¸­çš„Classå¯¹è±¡**é‡Œ
- **å¯¹è±¡å®ä¾‹**: å§‹ç»ˆå­˜å‚¨åœ¨**å †ä¸­**
- **æœ€ä½³å®è·µ**: é¿å…é™æ€å­—æ®µæŒæœ‰å¤§å¯¹è±¡ï¼Œæ— è®ºå­˜å‚¨ä½ç½®å¦‚ä½•

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ çš„ä»£ç ä¼šé€ æˆå†…å­˜æ³„æ¼â€”â€”é™æ€å­—æ®µ`testB`åœ¨å †ä¸­æŒæœ‰æœ€åä¸€ä¸ª`TestB`å®ä¾‹çš„å¼•ç”¨ï¼ğŸš¨